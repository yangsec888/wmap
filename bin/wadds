#!/usr/bin/env ruby
# Executable to bulk add sites into the tracking data repository
require "wmap"

def print_usage
	puts "Program to add sites from a file into local data repository. Usage: wadds [file_sites]"
end

puts Wmap.banner
print_usage
abort "Incorrect program argument!" unless File.exist?(ARGV[0])

if ARGV.length == 1
	# Log the command entry
	Log_dir = File.dirname(__FILE__)+'/../logs/'
elsif ARGV.length == 2
	# Log to the instance running directory
	Log_dir = File.dirname(__FILE__)+'/../logs/' + ARGV[1]
end
Dir.mkdir(Log_dir) unless Dir.exist?(Log_dir)
Wmap.wlog("Execute the command: wadds #{ARGV[0]}","wadds",Log_dir+"wmap.log")

if ARGV.length == 1
	puts puts "Invoke the SiteTracker."
	st=Wmap::SiteTracker.instance
	st.verbose=false
elsif ARGV.length == 2
	puts puts "Invoke the SiteTracker."
	st=Wmap::SiteTracker.instance
	st.verbose=false
	st.data_dir=ARGV[1]
else
	aborts "Error firing up SiteTracker instance!"
end

# Evaluate the argument and update the data store accordingly
sites=st.file_2_list(ARGV[0]).map { |x| st.url_2_site(x) }
if sites.length > 0
	news=st.adds(sites)
	puts news
	st.save! if news.length>0
	st=nil
else
	st=nil
	abort "No site entry found in file: #{ARGV[0]}. Please check your file format to ensure one site per line."
end
